<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCORM Test Player</title>
    
    <!-- Load scorm-again library BEFORE anything else -->
    <script src="https://cdn.jsdelivr.net/npm/scorm-again@latest/dist/scorm12.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/scorm-again@latest/dist/scorm2004.min.js"></script>
    
    <script>
        // Check if libraries loaded after a short delay
        setTimeout(() => {
            if (typeof Scorm12API === 'undefined' || typeof Scorm2004API === 'undefined') {
                console.error('‚ö†Ô∏è SCORM libraries did not load from CDN!');
                console.log('Trying alternative CDN...');
                
                // Try alternative CDN
                const script1 = document.createElement('script');
                script1.src = 'https://unpkg.com/scorm-again@latest/dist/scorm12.min.js';
                document.head.appendChild(script1);
                
                const script2 = document.createElement('script');
                script2.src = 'https://unpkg.com/scorm-again@latest/dist/scorm2004.min.js';
                document.head.appendChild(script2);
            } else {
                console.log('‚úÖ SCORM libraries loaded successfully');
                console.log('Scorm12API:', typeof Scorm12API);
                console.log('Scorm2004API:', typeof Scorm2004API);
            }
        }, 2000);
        
        // Pre-initialize dummy APIs immediately so SCORM content can find them
        // These will be replaced with real APIs when a package is loaded
        window.API = {
            LMSInitialize: function() { console.log('Waiting for real API...'); return "false"; },
            LMSFinish: function() { return "false"; },
            LMSGetValue: function() { return ""; },
            LMSSetValue: function() { return "false"; },
            LMSCommit: function() { return "false"; },
            LMSGetLastError: function() { return "0"; },
            LMSGetErrorString: function() { return "No error"; },
            LMSGetDiagnostic: function() { return ""; }
        };
        
        window.API_1484_11 = {
            Initialize: function() { console.log('Waiting for real API...'); return "false"; },
            Terminate: function() { return "false"; },
            GetValue: function() { return ""; },
            SetValue: function() { return "false"; },
            Commit: function() { return "false"; },
            GetLastError: function() { return "0"; },
            GetErrorString: function() { return "No error"; },
            GetDiagnostic: function() { return ""; }
        };
        
        console.log('‚úÖ Placeholder APIs created');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }
        
        .header {
            background: #2563eb;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.3em;
        }
        
        .api-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .api-status.ready {
            background: #10b981;
        }
        
        .player-container {
            height: calc(100vh - 60px);
            position: relative;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }
        
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-screen.hidden {
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1f2937;
            color: #f3f4f6;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            padding: 10px;
            border-top: 2px solid #2563eb;
            z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.3s;
        }
        
        .debug-panel.show {
            transform: translateY(0);
        }
        
        .debug-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 2001;
        }
        
        .debug-toggle:hover {
            background: #1d4ed8;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #4b5563;
        }
        
        .log-entry.initialize { border-color: #10b981; color: #10b981; }
        .log-entry.setvalue { border-color: #3b82f6; color: #60a5fa; }
        .log-entry.getvalue { border-color: #8b5cf6; color: #a78bfa; }
        .log-entry.commit { border-color: #f59e0b; color: #fbbf24; }
        .log-entry.terminate { border-color: #ef4444; color: #f87171; }
        .log-entry.error { border-color: #dc2626; color: #fca5a5; }
        
        .package-selector {
            background: white;
            padding: 40px;
            max-width: 600px;
            margin: 50px auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .package-selector h2 {
            color: #1f2937;
            margin-bottom: 20px;
        }
        
        .package-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .package-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .package-item:hover {
            background: #eff6ff;
            border-color: #2563eb;
            transform: translateX(5px);
        }
        
        .package-item h3 {
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .package-item p {
            color: #6b7280;
            font-size: 0.9em;
        }
        
        .no-packages {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .no-packages a {
            color: #2563eb;
            text-decoration: none;
            font-weight: 600;
        }
        
        .no-packages a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéì SCORM Test Player</h1>
        <div class="api-status" id="apiStatus">Auto-launching latest package...</div>
        <button onclick="showPackageSelector()" style="background: rgba(255,255,255,0.2); border: none; padding: 8px 15px; border-radius: 5px; color: white; cursor: pointer; font-size: 0.9em;">
            üìã Switch Package
        </button>
    </div>
    
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <div>Loading SCORM content...</div>
    </div>
    
    <div id="packageSelector" class="package-selector">
        <h2>Select a SCORM Package to Test</h2>
        <div class="package-list" id="packageList">
            <div class="spinner" style="margin: 40px auto;"></div>
        </div>
    </div>
    
    <div class="player-container" style="display: none;" id="playerContainer">
        <iframe id="scormFrame"></iframe>
    </div>
    
    <button class="debug-toggle" id="debugToggle">üìä Debug Console</button>
    
    <div class="debug-panel" id="debugPanel">
        <div id="debugLog"></div>
    </div>
    
    <script>
        // Configuration
        const API_BASE = window.location.origin + '/api';
        let currentSessionId = null;
        let scormApi = null;
        let scormVersion = null;
        
        // Initialize on load
        window.addEventListener('load', async () => {
            const packages = await loadPackages();
            
            // Auto-launch most recent package
            if (packages && packages.length > 0) {
                const latestPackage = packages[0]; // Already sorted by uploaded_at DESC
                log('üöÄ Auto-launching latest package: ' + latestPackage.title, 'initialize');
                
                // Wait a moment for UI to render
                setTimeout(() => {
                    launchPackage(latestPackage.id, latestPackage.scorm_version);
                }, 500);
            }
        });
        
        // Load available packages
        async function loadPackages() {
            try {
                const response = await fetch(`${API_BASE}/packages`);
                const data = await response.json();
                
                const packageList = document.getElementById('packageList');
                
                if (data.success && data.packages.length > 0) {
                    // Add "Latest" badge to first package
                    packageList.innerHTML = data.packages.map((pkg, index) => `
                        <div class="package-item" onclick="launchPackage('${pkg.id}', '${pkg.scorm_version}')">
                            <h3>${pkg.title} ${index === 0 ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7em; margin-left: 8px;">LATEST</span>' : ''}</h3>
                            <p>SCORM ${pkg.scorm_version} ‚Ä¢ ${pkg.file_size ? Math.round(pkg.file_size / 1024 / 1024) + ' MB' : 'Unknown size'}</p>
                        </div>
                    `).join('');
                    
                    return data.packages; // Return packages for auto-launch
                } else {
                    packageList.innerHTML = `
                        <div class="no-packages">
                            <p>No SCORM packages found.</p>
                            <p><a href="/upload.html">Upload a package</a> to get started.</p>
                        </div>
                    `;
                    return [];
                }
            } catch (error) {
                document.getElementById('packageList').innerHTML = `
                    <div class="no-packages">
                        <p style="color: #ef4444;">Error loading packages: ${error.message}</p>
                    </div>
                `;
                return [];
            }
        }
        
        // Launch SCORM package
        async function launchPackage(packageId, version) {
            try {
                log('üöÄ Launching package: ' + packageId, 'initialize');
                
                // Hide package selector
                document.getElementById('packageSelector').style.display = 'none';
                document.getElementById('playerContainer').style.display = 'block';
                document.getElementById('loadingScreen').classList.remove('hidden');
                
                // Determine SCORM version
                scormVersion = version.startsWith('2004') ? '2004' : '1.2';
                log('üìã Detected SCORM version: ' + scormVersion, 'initialize');
                
                // Check if libraries are loaded
                if (typeof Scorm12API === 'undefined' || typeof Scorm2004API === 'undefined') {
                    log('‚ö†Ô∏è Waiting for libraries to load...', 'initialize');
                    // Wait up to 5 seconds for libraries
                    let attempts = 0;
                    while ((typeof Scorm12API === 'undefined' || typeof Scorm2004API === 'undefined') && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    
                    if (typeof Scorm12API === 'undefined' || typeof Scorm2004API === 'undefined') {
                        throw new Error('SCORM libraries failed to load from CDN. Check your internet connection or try refreshing the page.');
                    }
                }
                
                log('‚úÖ Libraries loaded successfully', 'initialize');
                
                // Initialize SCORM API FIRST
                await initializeScormAPI(packageId);
                log('‚úÖ SCORM API initialized', 'initialize');
                
                // Initialize session on server
                await initializeSession(packageId);
                log('‚úÖ Session created', 'initialize');
                
                // Get launch URL
                const launchResponse = await fetch(`${API_BASE}/packages/${packageId}/launch`);
                const launchData = await launchResponse.json();
                
                if (!launchData.success) {
                    throw new Error(launchData.error || 'Failed to get launch URL');
                }
                
                log('üìç Launch URL: ' + launchData.launchUrl, 'initialize');
                
                // Wait a moment to ensure API is fully ready
                await new Promise(resolve => setTimeout(resolve, 500));
                
                log('üé¨ Loading SCORM content into iframe...', 'initialize');
                
                // Load content in iframe
                const iframe = document.getElementById('scormFrame');
                
                // Set up iframe load handlers
                let loadTimeout = setTimeout(() => {
                    log('‚ö†Ô∏è Content is taking longer than expected to load...', 'initialize');
                }, 5000);
                
                iframe.onerror = (error) => {
                    clearTimeout(loadTimeout);
                    log('‚ùå Error loading iframe: ' + error, 'error');
                    document.getElementById('loadingScreen').innerHTML = 
                        '<div class="spinner"></div><div>Error loading content. Check console for details.</div>';
                };
                
                iframe.onload = () => {
                    clearTimeout(loadTimeout);
                    try {
                        // Try to help the content find the API
                        if (iframe.contentWindow) {
                            log('üì¶ Iframe loaded, checking API accessibility...', 'initialize');
                            
                            // Log what APIs are available
                            if (window.API) {
                                log('‚úÖ window.API is available (SCORM 1.2)', 'initialize');
                            }
                            if (window.API_1484_11) {
                                log('‚úÖ window.API_1484_11 is available (SCORM 2004)', 'initialize');
                            }
                        }
                    } catch (e) {
                        log('‚ÑπÔ∏è Cross-origin iframe - API will be found via window search', 'initialize');
                    }
                    
                    document.getElementById('loadingScreen').classList.add('hidden');
                    log('‚úÖ SCORM content loaded successfully!', 'initialize');
                    log('üéØ Content should now be able to find the API', 'initialize');
                };
                
                // Load the content
                log('üì° Setting iframe src...', 'initialize');
                iframe.src = launchData.launchUrl;
                
            } catch (error) {
                log('‚ùå Launch error: ' + error.message, 'error');
                document.getElementById('loadingScreen').innerHTML = 
                    `<div style="color: #ef4444; padding: 40px; text-align: center;">
                        <h2>Launch Failed</h2>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Reload Page
                        </button>
                    </div>`;
            }
        }
        
        // Initialize SCORM API
        async function initializeScormAPI(packageId) {
            log('Initializing SCORM ' + scormVersion + ' API', 'initialize');
            
            // Make sure libraries are loaded
            if (typeof Scorm12API === 'undefined' || typeof Scorm2004API === 'undefined') {
                log('ERROR: scorm-again libraries not loaded!', 'error');
                throw new Error('SCORM libraries not loaded. Please refresh the page.');
            }
            
            const apiSettings = {
                autocommit: true,
                autocommitSeconds: 10,
                logLevel: 1, // DEBUG
                lmsCommitUrl: `${API_BASE}/scorm/${packageId}/commit`,
                
                // Make commits work offline for testing
                useAsynchronousCommits: true,
                
                requestHandler: (commitObject) => {
                    log('Committing data to server', 'commit');
                    return {
                        sessionId: currentSessionId,
                        data: commitObject,
                    };
                },
                
                responseHandler: async (response) => {
                    try {
                        const data = await response.json();
                        log('Server response received', 'commit');
                        return {
                            result: data.success || true,
                            errorCode: 0,
                        };
                    } catch (e) {
                        log('Using offline mode for commits', 'commit');
                        return {
                            result: true,
                            errorCode: 0,
                        };
                    }
                },
                
                // Log all API calls
                onLogMessage: (level, message) => {
                    console.log(`[SCORM API] ${message}`);
                },
            };
            
            // Create the appropriate API version
            if (scormVersion === '1.2') {
                scormApi = new Scorm12API(apiSettings);
                window.API = scormApi;
                
                // Also expose in iframe's parent for API discovery
                console.log('‚úÖ SCORM 1.2 API attached to window.API');
                
                // Setup event listeners
                scormApi.on('LMSInitialize', () => {
                    log('LMSInitialize() called', 'initialize');
                    updateApiStatus('API Ready (SCORM 1.2)');
                });
                
                scormApi.on('LMSSetValue.*', (element, value) => {
                    log(`LMSSetValue("${element}", "${value}")`, 'setvalue');
                });
                
                scormApi.on('LMSGetValue.*', (element, value) => {
                    log(`LMSGetValue("${element}") = "${value}"`, 'getvalue');
                });
                
                scormApi.on('LMSCommit', () => {
                    log('LMSCommit() called', 'commit');
                });
                
                scormApi.on('LMSFinish', () => {
                    log('LMSFinish() called', 'terminate');
                });
                
                log('SCORM 1.2 API attached to window.API', 'initialize');
                
            } else {
                scormApi = new Scorm2004API(apiSettings);
                window.API_1484_11 = scormApi;
                
                // Also expose in iframe's parent for API discovery
                console.log('‚úÖ SCORM 2004 API attached to window.API_1484_11');
                
                // Setup event listeners
                scormApi.on('Initialize', () => {
                    log('Initialize() called', 'initialize');
                    updateApiStatus('API Ready (SCORM 2004)');
                });
                
                scormApi.on('SetValue.*', (element, value) => {
                    log(`SetValue("${element}", "${value}")`, 'setvalue');
                });
                
                scormApi.on('GetValue.*', (element, value) => {
                    log(`GetValue("${element}") = "${value}"`, 'getvalue');
                });
                
                scormApi.on('Commit', () => {
                    log('Commit() called', 'commit');
                });
                
                scormApi.on('Terminate', () => {
                    log('Terminate() called', 'terminate');
                });
                
                log('SCORM 2004 API attached to window.API_1484_11', 'initialize');
            }
            
            updateApiStatus('API Initialized');
        }
        
        // Initialize session on server
        async function initializeSession(packageId) {
            try {
                const response = await fetch(`${API_BASE}/scorm/${packageId}/initialize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 'test_user_' + Date.now(),
                        resume: false,
                    }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentSessionId = data.sessionId;
                    log('Session created: ' + currentSessionId, 'initialize');
                } else {
                    log('Warning: Session creation failed, running in offline mode', 'error');
                    currentSessionId = 'offline_' + Date.now();
                }
            } catch (error) {
                log('Warning: Could not connect to server, running offline', 'error');
                currentSessionId = 'offline_' + Date.now();
            }
        }
        
        // Update API status indicator
        function updateApiStatus(status) {
            const statusEl = document.getElementById('apiStatus');
            statusEl.textContent = status;
            if (status.includes('Ready')) {
                statusEl.classList.add('ready');
            }
        }
        
        // Log to debug panel
        function log(message, type = 'info') {
            const debugLog = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            debugLog.appendChild(entry);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // Toggle debug panel
        document.getElementById('debugToggle').addEventListener('click', () => {
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('show');
        });
        
        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (scormApi && currentSessionId) {
                try {
                    if (scormVersion === '1.2') {
                        scormApi.LMSFinish('');
                    } else {
                        scormApi.Terminate('');
                    }
                } catch (e) {
                    console.error('Error on cleanup:', e);
                }
            }
        });
        
        // Show package selector
        function showPackageSelector() {
            document.getElementById('packageSelector').style.display = 'block';
            document.getElementById('playerContainer').style.display = 'none';
            document.getElementById('loadingScreen').classList.add('hidden');
        }
        
        // Make API globally accessible for debugging
        window.getScormAPI = () => scormApi;
        window.debugAPI = () => {
            if (scormVersion === '1.2') {
                console.log('SCORM 1.2 API:', window.API);
                console.log('CMI Data:', window.API.cmi);
            } else {
                console.log('SCORM 2004 API:', window.API_1484_11);
                console.log('CMI Data:', window.API_1484_11.cmi);
            }
        };
    </script>
</body>
</html>
